{{ define "main" }}
<article class="page speakers-page">
  <div class="container">
    <h1>{{ .Title }}</h1>
    {{ .Content }}

    {{/* Collect speaker -> talks map safely */}}
    {{ $speakers := dict }}
    {{ range .Site.Data.talks }}
      {{ $year := .year }}
      {{ range .events }}
        {{ if .talks }}
          {{ range .talks }}
            {{ with .speaker }}
              {{ $talk := dict "year" $year "title" .title }}
              {{ $existing := index $speakers . | default (slice) }}
              {{ $speakers = merge $speakers (dict . (append $existing $talk)) }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{/* Sorted speaker names */}}
    {{ $speakerNames := slice }}
    {{ range $name, $_ := $speakers }}
      {{ $speakerNames = $speakerNames | append $name }}
    {{ end }}
    {{ $speakerNames = sort $speakerNames }}

    <p class="speaker-count"><strong>{{ len $speakerNames }}</strong> speakers since 1986</p>

    <div class="speaker-list">
      {{ range $speakerNames }}
        {{ $currentSpeaker := . }}
        {{ $talks := index $speakers $currentSpeaker | sort "year" "desc" }}
        <div class="speaker-entry">
          <h3 class="speaker-name">{{ $currentSpeaker }}</h3>
          <ul class="speaker-talks">
            {{ range $talks }}
              <li>
                <span class="talk-year">{{ .year }}</span>
                <span class="talk-title">{{ .title }}</span>
              </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    </div>
  </div>
</article>
{{ end }}
